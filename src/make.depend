# -*- Makefile -*-
#
# ----------------------------------------------------------------------
# @file    make.depend
# @author  Benjamin Gerard AKA Ben/OVR
# @date    2017-08-17
# @brief   Make rules for depend related targets
# ----------------------------------------------------------------------
#

depends  = $(sources:.c=.d)
cc_conf := cc_conf.h

# Avoid creating dependencies for targets matching these patterns
ignore_dep = clean% dist% uninstall%

ifeq ($(words $(MAKECMDGOALS)),0)
filtered = ST forever
else
filtered = $(filter-out $(ignore_dep),$(MAKECMDGOALS))
endif

ifdef NODEPS
filtered =
endif

# Setup CCDEP depending on NODEPS

ifeq ($(words $(filtered)),0)

CCDEP = true
.SILENT: $(depends)

else

dep_CFLAGS ?= $(strip $(CPPFLAGS) $(CFLAGS))
CC_CONF_O  := $(file <$(cc_conf))
CC_CONF_N   = /* $(VERSION): $(dep_CFLAGS) */

ifneq ($(CC_CONF_O),$(CC_CONF_N))
$(file >$(cc_conf),$(CC_CONF_N))
$(info Generating [$(cc_conf)])
endif

$(cc_conf): $(srcdir)/Makefile $(wildcard $(topdir)/src/make.*)
	@echo "[UPD] $@"; touch "$@"

CCDEP = $(CC)
DEP_FLAGS = -include $(cc_conf) -MM -MG -MF $@
-include $(depends)

endif

# ----------------------------------------------------------------------

depend: $(depends)
.PHONY: depend

# ----------------------------------------------------------------------
#  Static or implicite rules
# ----------------------------------------------------------------------

$(depends): %.d: %.c
	@echo "[DEP] $*"; $(CCDEP) $(dep_CFLAGS) $(DEP_FLAGS) -c $<
